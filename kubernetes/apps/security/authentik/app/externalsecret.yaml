apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name authentik-secret
  namespace: security
spec:
  refreshInterval: 15m
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-secrets-manager
  target:
    name: *name
    template:
      engineVersion: v2
      data:
        #App
        AUTHENTIK_BOOTSTRAP_EMAIL: "{{ .AUTHENTIK_BOOTSTRAP_EMAIL }}"
        AUTHENTIK_BOOTSTRAP_PASSWORD: "{{ .AUTHENTIK_BOOTSTRAP_PASSWORD }}"
        AUTHENTIK_BOOTSTRAP_TOKEN: "{{ .AUTHENTIK_BOOTSTRAP_TOKEN }}"
        AUTHENTIK_SECRET_KEY: "{{ .AUTHENTIK_SECRET_KEY }}"
        AUTHENTIK_REDIS__DB: "{{ .AUTHENTIK_REDIS__DB }}"
        # Email
        AUTHENTIK_EMAIL__HOST: "{{ .email_host }}"
        AUTHENTIK_EMAIL__PORT: "{{ .email_port }}"
        AUTHENTIK_EMAIL__USERNAME: "{{ .email_username }}"
        AUTHENTIK_EMAIL__PASSWORD: "{{ .email_password }}"
        AUTHENTIK_EMAIL__USE_TLS: "{{ .AUTHENTIK_EMAIL__USE_TLS }}"
        AUTHENTIK_EMAIL__FROM: "{{ .AUTHENTIK_EMAIL__FROM }}"
  dataFrom:
    - extract:
        key: *name
    - extract:
        key: smtp
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: &name authentik-db-secret
  namespace: security
spec:
  refreshInterval: 15m
  secretStoreRef:
    kind: ClusterSecretStore
    name: crunchy-postgres
  target:
    name: *name
    template:
      engineVersion: v2
      data:
        AUTHENTIK_POSTGRESQL__NAME: '{{ index . "dbname" }}'
        AUTHENTIK_POSTGRESQL__HOST: '{{ index . "pgbouncer-host" }}'
        AUTHENTIK_POSTGRESQL__PORT: '{{ index . "pgbouncer-port" }}'
        AUTHENTIK_POSTGRESQL__USER: '{{ index . "user" }}'
        AUTHENTIK_POSTGRESQL__PASSWORD: '{{ index . "password" }}'
        AUTHENTIK_POSTGRESQL__USE_PGBOUNCER: "true"
  dataFrom:
    - extract:
        key: crunchy-postgres-pguser-authentik-admin
---
# apiVersion: external-secrets.io/v1beta1
# kind: ExternalSecret
# metadata:
#     name: &name authentik-db-init
#     namespace: security
# spec:
#     refreshInterval: 15m
#     secretStoreRef:
#         kind: ClusterSecretStore
#         name: bitwarden-secrets-manager
#     target:
#       name: *name
#       template:
#         engineVersion: v2
#         data:
#           INIT_POSTGRES_DBNAME: "{{ .AUTHENTIK_POSTGRESQL__NAME }}"
#           INIT_POSTGRES_HOST: "{{ .host }}"
#           INIT_POSTGRES_USER: "{{ .AUTHENTIK_POSTGRESQL__USER }}"
#           INIT_POSTGRES_PASS: "{{ .AUTHENTIK_POSTGRESQL__PASSWORD }}"
#           INIT_POSTGRES_SUPER_PASS: "{{ .password }}"
#     dataFrom:
#       - extract:
#           key: authentik-secret
#       - extract:
#           key: postgres-superuser
